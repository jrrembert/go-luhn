name: Release

on:
  push:
    branches: [main, rc]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    if: github.repository == 'jrrembert/go-luhn'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
      - run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.21'
      - name: Register with Go module proxy
        run: |
          git fetch --tags
          VERSION=$(git tag --points-at HEAD | head -1)
          if [ -n "$VERSION" ]; then
            echo "Registering $VERSION with Go module proxy..."
            for attempt in 1 2 3 4 5; do
              if GOPROXY=https://proxy.golang.org go list -m "github.com/jrrembert/go-luhn@$VERSION" 2>/dev/null; then
                echo "Successfully registered $VERSION"
                exit 0
              fi
              echo "Attempt $attempt failed, waiting 30 seconds..."
              sleep 30
            done
            echo "::warning::Failed to register $VERSION with Go module proxy after 5 attempts"
          else
            echo "No new tag created, skipping proxy registration."
          fi
